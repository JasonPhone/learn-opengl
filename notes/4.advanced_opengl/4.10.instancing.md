# 实例化

如果你要画很多个物体，而这些物体又都是相同的顶点数据，那每次绑定数据并调用 `glDrawXxx()` （一次 draw call，指过一次管线）就会很吃性能（主要瓶颈在 CPU 向 GPU 传数据和指令）。

实例化可以在一次渲染调用中绘制多个顶点数据相同的物体，对应的函数是 `glDrawXxxInstanced()`。与非实例化的绘制函数相比，它们额外接收一个整数作为实例数量（instance count），对应的数据被一次送给 GPU，而不是在多次绘制中间持续与 GPU 交流。

GLSL 通过内置的 `gl_InstanceID` 来区分实例，如果配合一个提前传给（比如 uniform 或者纹理） GPU 的数组，就可以进行各种差异性的操作。

使用 uniform 向 shader 传送不同实例的数据很容易遇到 uniform 数量限制的问题。这时可以使用 instanced arrays 来传输数据。instanced arrays 属于顶点属性，但是随每个 instance 更新，而不是随每个顶点。在顶点着色器中 instanced arrays 的形式和普通的顶点数据相同。顶点属性的更新由 `glVertexAttribDivisor()` 控制，可以指定更新的属性索引和 attribute divisor，即隔多少个实例按设定的布局更新一次给定的顶点属性（0就是每个顶点都更新）。以顶点属性的方式传输实例数据就不会遇到 uniform 的数量问题。需要注意的是，由于一个顶点数据最大支持一个 `vec4`，传入一个齐次矩阵会占用四个布局位置。

但是吧，在我的电脑上物体拉到四万个还是没有看到什么差距。甚至传统画法还稍微快那么两帧。



