# 5.3.1 Shadow Mapping

## 原理

从光源视角渲染一遍场景，记录下最近片段的距离（通过深度缓冲实现），接着进行正常的渲染，每个片段到光源的距离如果大于最近距离则判定为在阴影中。

## 问题和解决

### Shadow Acne

简单 Shadow Mapping 实现时会看到的摩尔纹，原因是从光源视角渲染的 shadow map 分辨率不够，用作阴影距离参考时容易出现一个 texel 覆盖的片段有的判定在阴影中有的不在。

可以在判定阴影的时候加一个偏移距离来抵消 shadow map 的锯齿。更好的办法是使用一个自适应的偏移，相对光源倾斜的表面使用大偏移量，垂直于光源的表面使用小偏移量。

把光源的视锥设小一些也可以缓解，此时采样率变高了。

### Peter panning

偏移量太大导致的，使物体的阴影太远，看起来像物体在漂浮。在渲染 shadow map 的时候裁剪前向面可以稍微缓解，此时注意偏移量要再给小一些。

### 视锥边界

光源的视锥大小就是 shadow map 的绝对尺寸。如果场景过大，视锥的边界就会投射在场景里，表现为只有边界内的物体被照亮。

两个地方要解决。视锥的平面大小也决定了 shadow map 的尺寸，设定纹理的包围方式为边界截断，并将边界值指定为 1（无限远），可以解决 xy 方向的边界；使用与教程里相反的比较逻辑（1 代表在光源下、0 代表在阴影里）或者对深度大于 1 的片段进行特判，可以解决 z 方向的边界。

### 阴影锯齿

也是分辨率的问题。使用 PCF（Percentage-Closer Filtering）生成（假的）软阴影来缓解。原理有些像离线渲染的 ray-differential，不过没那么精准。

## 其他问题

model 矩阵记得变化。MVP 矩阵的含义。

`gl_Position` 从顶点着色器接收的坐标会自行做一次透视除法。不使用这个变量接收的坐标要注意自己做一次。

光源矩阵是世界空间到光源视角空间的映射，注意要应用在顶点的世界坐标上。