# 3.3 模型

主要就是关于 Assimp 流程化的东西和 Model、Mesh 类的抽象。等有空了详细写一下流程。


## tiny_obj_loader

乐，Assimp 太大，换成 tiny_obj_loader 了。接下来写一下怎么把这个库替换进项目。这是一个 header-only 的库，所以编译链接并不麻烦。只支持 OBJ，不过很够了。

Assimp 加载进来的抽象数据结构是树形的，根据数组来做索引，tiny_obj_loader 貌似直接就是数组。

原来的 `Model` 类把 OBJ 读到场景（Assimp 自己的类型）里之后递归地处理每个节点。对于每个节点，先处理直属的网格，再处理子节点。每个网格的对应数据都是直接转存到我们内建的类型中，包括：

- 顶点数据
  - 位置
  - 法向量
  - 纹理坐标
- 顶点索引
- 纹理
  - diffuse
  - specular
  - normal
  - height

基于图片的纹理被读进来之后直接转换成 OpenGL 的纹理，索引、种类和路径都放到自建的 `Texture` 结构体里。

然后来理一下 tiny_obj_loader。它把读进来的数据存到三个类型里：自建的属性结构体 `attrib_t`、形状 `shape_t` 列表和材质 `material_t` 列表。后两者都是 STL 的 `vector`。此外，tiny_obj_loader 还需要两个 `std::string` 来存放警告和错误信息。

属性结构体记录了位置（和位置权重，还不清楚有什么用）、法向量、纹理坐标（w 向量另外存放）、颜色和皮肤权重（不清楚+1）；形状对应着 OBJ 里面的单个对象，存放了形状的名称、网格（`mesh_t`）、线（`lines_t`，大概是线条？）和点（`points_t`），其内部的数据都是索引；纹理的结构比较复杂，等下再说。先看布局和读取方式。

按单独的 `shape_t` 来从线性数据中读取对应的那个网格。对于每个 `shape_t` 的网格会分许多面，面包括顶点、法向量和纹理坐标的索引，对应的数据在 `attrib_t` 里线性存放。

每个面有一个材质 ID。材质已经直接读进来了，不用再像 Assimp 那样从文件去读。但是这样的话要根据它的布局向 OpenGL 填充数据。

理清楚结构之后的工作就是把对应的代码翻译一下了。

实现期间主要的问题还是 Assimp、tiny_obj_loader 和自建数据类型之间结构和逻辑的问题。Assimp 把索引转换全都做好了，而 tiny_obj_loader 全是基于全局索引的，还针对每个三角面都存了一次材质，但自建的模型类只需要精确到网格。