# 1.4 第一个三角形

## 图形管线

OpenGL 做的事情总体来说是把 3D 坐标转换为 2D 像素。图形渲染管线就是执行这个任务的流水线。

1. 顶点数据（位置、颜色、法向量等）被送入顶点着色器。顶点着色器接收单独的顶点，对 3D 坐标进行变换后将其送入图元装配。
2. 图元装配是固定流程，它接收所有顶点，将它们装配成指定的图元（单点、三角形等等）。形成图元的顶点集合被送入几何着色器。
3. 几何着色器可以产生新的顶点，构造出新的图元。生成的所有图元被送入光栅化阶段。
4. 在光栅化阶段，所有连续的坐标都被映射为离散的像素，同时用户无法看见的像素会被丢弃。包含像素的片段会被传给片段着色器。
5. 片段着色器主要计算像素的颜色。
6. 经过片段着色器处理的数据进入 Alpha 测试和混合阶段，处理遮挡、透明等等视觉效果。

以上就是图形管线的大致流程。其中，所有被称为“着色器”的部分都是可编程的。

GPU 中没有默认的顶点着色器和片段着色器，需要我们自定义。

## 顶点输入 VBO

顶点的坐标都是三维的，取值范围没有限制，但只有在单位立方体（Normalized Device Coordinates）内的顶点才会被绘制在初始的显示区（`glViewport` 指示的区域）内。

顶点数据在程序中的形式是一块浮点数数组。将其传入管线后会存储在 GPU 的显存里，通过 Vertex Buffer Object 管理。CPU 和 GPU 之间的传输比较慢，所以需要这样整体发送。申请一个缓冲区，使用一个无符号整型变量作为它的句柄，将其绑定为 VBO 的缓冲类型 `GL_ARRAY_BUFFER`，就可以通过在 `GL_ARRAY_BUFFER` 上的调用来配置申请的缓冲区，比如使用 `glBufferData` 传入用户定义的数据。

## 顶点着色器

着色器的编写涉及到 shading language。这种语言比较多样，OpenGL 使用的是 GLSL。shader 在程序中的形式是一个字符串，可以硬编码或者从什么地方读取进来。shader 是给 GPU 运行的程序，所以它需要编译。和缓冲对象一样，shader 对象需要一个句柄来引用或者访问，类似地先创建对应类型的 shader，传入源码，编译。编译可能报错，可以用 `glGetShaderiv` 来获取编译状态，然后用 `glGetShaderInfoLog` 获取错误消息。

## 片段着色器

类似操作。

## 着色器程序

编译好的各部分 shader 需要链接成一个完整的 shader program。我们需要创建一个 program 对象，用 `glAttachShader` 将之前编译好的 shader 附加上去，最后使用 `glLinkProgram` 链接。链接情况和产生的错误消息也可以用类似编译 shader 时的方式获取。得到的程序对象就可以使用 `glUseProgram` 来调用。链接结束后之前的 shader 可以用 `glDeleteShader` 删除。

## 链接顶点属性

我们已经提供了顶点数据和处理顶点属性的流程，还需要解决的是如何解释内存中的顶点数据，使 OpenGL 可以将它们与顶点属性对应。

需要使用 `glVertexAttribPointer` 指出顶点数据的内存布局，包括

- 要配置的顶点属性的位置
- 顶点属性的大小（值的数量）
- 数据类型（浮点、整型等）
- 是否需要将数据标准化
- 数据步长
- 此属性数据在缓冲对象起始位置的偏移量，是空指针类型

顶点属性来自于配置属性时绑定的那个 VBO 管理的内存。

之后，使用 `glEnableVertexAttribArray` 激活顶点的位置属性。

至此，数据和处理方式已经就绪。需要绘制图形时，先绑定顶点数组并传入数据，再设置顶点属性指针并激活，然后指定着色器程序，最后进行绘制流程。

## 顶点数组对象 VAO

像上面那样的流程固定而且繁琐，如果能像 VBO 存储顶点数据一样把这些过程也存起来将绝杀。Vertex Array Object 就是做这个的，它存储顶点属性配置和调用的流程，使得切换顶点数据和属性的代码更方便管理，开销也更小。OpenGL 的核心模式要求使用 VAO。

一个 VAO 会存储 `glEnableVertexAttribArray` 和 `glDisableVertexArray` 的调用、通过 `glVertexAttribPointer` 配置的顶点属性和关联的 VBO 以及当前绑定的 EBO。只要在绑定 VBO 之前绑定一个 VAO，它就可以记录这些信息，之后只需要直接绑定 VAO、指定着色器程序就可以开始绘制。（通过传入 0 来解绑）

## 三角形

`glDrawArrays` 使用当前的着色器程序、顶点数据和顶点属性配置来绘制指定的图元，传入图元类型、第一个顶点在顶点数组中的位置和绘制顶点数量，就可以绘制出对应的图元。

## 元素缓冲对象（索引缓冲对象）

Element Buffer Object，或者说 Index Buffer Object 主要用来解决重复顶点的问题。它记录不同的顶点以及顶点的绘制顺序，来减少重复存储或绘制顶点的开销。

EBO 通过类似设置 VBO 的方式从用户提供的索引数组中获取数据。之后需要将绘制图元的函数由 draw arrays 改为 draw elements，即 `glDrawElements`，指定绘制图元类型、索引数量、索引类型（内存布局）和索引偏移（如果没有绑定 EBO，可以传入一个索引数组）。

EBO 的配置也可以被 VAO　记录。


